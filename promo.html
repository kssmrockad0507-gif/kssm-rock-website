<!DOCTYPE html>
<html>
<head>
    <title>Promo Code</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        body {
            margin: 0; padding: 0;
            background: linear-gradient(180deg, #0e5d63, #07404b);
            font-family: Arial, sans-serif;
            color: white;
            text-align: center;
        }

        .exitBtn {
            position: fixed;
            top: 15px; left: 15px;
            background: white;
            padding: 9px 16px;
            color: black;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1000;
        }

        .coinBoxTop {
            position: fixed;
            top: 15px; right: 15px;
            background: white;
            padding: 8px 18px;
            color: black;
            border-radius: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            z-index: 1000;
        }

        .coinIcon {
            width: 25px;
            margin-right: 8px;
        }

        .card {
            width: 90%;
            margin: 120px auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            color: black;
        }

        .promoInput {
            width: 95%;
            padding: 15px;
            font-size: 20px;
            border-radius: 15px;
            border: 2px solid #195c63;
            outline: none;
        }

        .applyBtn {
            background: linear-gradient(180deg, #195c63, #0d434a);
            padding: 15px;
            width: 95%;
            color: white;
            border-radius: 15px;
            font-size: 22px;
            margin-top: 15px;
            font-weight: bold;
            cursor: pointer;
        }

        .tgBox {
            width: 90%;
            background: white;
            padding: 15px;
            border-radius: 20px;
            margin: 25px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
        }

        .tgLogo {
            width: 30px;
            margin-right: 10px;
        }

        #msg {
            font-size: 20px;
            margin-top: 12px;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="exitBtn" onclick="goHome()">‚Üê Back</div>

    <div class="coinBoxTop">
        <img class="coinIcon" src="https://cdn-icons-png.flaticon.com/512/138/138292.png">
        <span id="userCoins">0</span>
    </div>

    <div class="card">
        <h2>Enter Promo Code</h2>

        <input id="promoCode" class="promoInput" placeholder="Enter Promo Code">

        <div class="applyBtn" onclick="applyPromo()">APPLY</div>

        <div id="msg"></div>
    </div>

    <div class="tgBox" onclick="openTG()">
        <img class="tgLogo" src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg">
        For Latest Promo Codes
    </div>

    <!-- FIREBASE -->
    <script type="module">

        const firebaseConfig = {
            apiKey: "AIzaSyCBgBWfpUbtlPbvCfDr6N1_L2svtJglfhM",
            authDomain: "kssm-rock-tam-ad.firebaseapp.com",
            projectId: "kssm-rock-tam-ad",
            storageBucket: "kssm-rock-tam-ad.firebasestorage.app",
            messagingSenderId: "28268633766",
            appId: "1:28268633766:web:f6ee57eaf56f7cbd37de67"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc }
            from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged }
            from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth();

        let userId = null;
        let userCoins = 0;
        let today = new Date().toISOString().split("T")[0];

        // LOAD USER
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;

                const ref = doc(db, "users", userId);
                const snap = await getDoc(ref);

                if (snap.exists()) {
                    userCoins = snap.data().coins || 0;
                    document.getElementById("userCoins").innerHTML = userCoins;
                }
            }
        });

        // APPLY PROMO
        window.applyPromo = async function () {

            const msg = document.getElementById("msg");
            let code = document.getElementById("promoCode").value.trim();

            if (!userId) {
                msg.style.color = "red";
                msg.innerHTML = "Login required!";
                return;
            }

            // CHECK IF ALREADY CLAIMED TODAY
            const claimRef = doc(db, "promoClaims", userId, "daily", today);
            const claimSnap = await getDoc(claimRef);

            if (claimSnap.exists()) {
                msg.style.color = "red";
                msg.innerHTML = "‚úî You already used today's promo!";
                return;
            }

            // TODAY PROMO CODE
            const todayCode = "KSSM100";

            if (code !== todayCode) {
                msg.style.color = "red";
                msg.innerHTML = "‚ùå Invalid Promo Code!";
                return;
            }

            const reward = 20;
            userCoins += reward;

            // UPDATE USER COINS
            await updateDoc(doc(db, "users", userId), {
                coins: userCoins,
                lastPromo: today
            });

            // SAVE CLAIM RECORD
            await setDoc(claimRef, {
                claimedCode: code,
                reward: reward,
                claimDate: today
            });

            document.getElementById("userCoins").innerHTML = userCoins;
            msg.style.color = "green";
            msg.innerHTML = "üéâ Promo Applied! +" + reward + " coins!";
        }

        window.openTG = function () {
            window.location.href = "https://t.me/kssmrockreward";
        }

        window.goHome = function () {
            window.location.href = "index.html";
        }

    </script>

</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <title>Promo Code</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
</head>

<body>
    <h2>Enter Promo Code</h2>

    <input id="promoInput" type="text" placeholder="Enter Code">
    <button onclick="applyPromo()">Apply</button>

    <p id="msg"></p>

<script>
    // YOUR FIREBASE CONFIG
    const firebaseConfig = {
        apiKey: "AIzaSyCBgBWfpUbtlPbvCfDr6N1_L2svtJglfhM",
        authDomain: "kssm-rock-tam-ad.firebaseapp.com",
        projectId: "kssm-rock-tam-ad",
        storageBucket: "kssm-rock-tam-ad.firebasestorage.app",
        messagingSenderId: "28268633766",
        appId: "1:28268633766:web:f6ee57eaf56f7cbd37de67"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    async function applyPromo() {
        const code = document.getElementById("promoInput").value.trim();
        const msgBox = document.getElementById("msg");

        if (code === "") {
            msgBox.innerHTML = "❌ Please enter a code";
            return;
        }

        // Check user login
        const user = auth.currentUser;
        if (!user) {
            msgBox.innerHTML = "❌ Please login first";
            return;
        }

        const uid = user.uid;

        try {
            // Fetch promo code details
            const promoRef = db.collection("promoCodes").doc(code);
            const promoSnap = await promoRef.get();

            if (!promoSnap.exists) {
                msgBox.innerHTML = "❌ Invalid Promo Code!";
                return;
            }

            const promoData = promoSnap.data();

            // Check expiry
            const today = new Date();
            const expiryDate = new Date(promoData.expireAt);

            if (today > expiryDate) {
                msgBox.innerHTML = "❌ Promo code expired!";
                return;
            }

            // Fetch user data
            const userRef = db.collection("users").doc(uid);
            const userSnap = await userRef.get();
            const userData = userSnap.data();

            // Check already used
            if (userData.usedCodes.includes(code)) {
                msgBox.innerHTML = "❌ You already used this code!";
                return;
            }

            // Add coins
            const newCoins = userData.coins + promoData.coins;

            await userRef.update({
                coins: newCoins,
                usedCodes: [...userData.usedCodes, code]
            });

            msgBox.innerHTML = "✅ Success! Coins added: " + promoData.coins;

        } catch (err) {
            msgBox.innerHTML = "❌ Error: " + err.message;
        }
    }
</script>

</body>
</html>

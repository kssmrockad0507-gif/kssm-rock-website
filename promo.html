<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Promo Code</title>

<style>
body { font-family: Arial; padding: 20px; background: #fff; }
h2 { text-align:center; }
input {
  width: 100%; padding: 15px; font-size: 18px;
  border: 1px solid #ccc; border-radius: 10px;
  text-align: center;
}
button {
  width: 100%; padding: 15px; margin-top: 15px;
  background: #007bff; color: white; border: none;
  border-radius: 10px; font-size: 20px;
}
.box {
  padding:15px; background:#eee; border-radius:10px;
  margin-bottom:20px; text-align:center; font-size:20px;
}
</style>
</head>

<body>

<h2>Promo Code</h2>

<div class="box">
Your Coins: <span id="coins">0</span>
</div>

<input id="code" placeholder="Enter Promo Code">

<button onclick="applyPromo()">Apply</button>

<br><br>

<button onclick="window.location.href='https://t.me/kssmrockreward'">
Join Telegram for new codes
</button>

<!-- Firebase Scripts -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>

<script>
// FIREBASE CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyCBgBWfpUbtlPbvCfDr6N1_L2svtJglfhM",
  authDomain: "kssm-rock-tam-ad.firebaseapp.com",
  projectId: "kssm-rock-tam-ad",
  storageBucket: "kssm-rock-tam-ad.firebasestorage.app",
  messagingSenderId: "28268633766",
  appId: "1:28268633766:web:f6ee57eaf56f7cbd37de67"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let UID = null;

// WHEN USER IS LOGGED IN
auth.onAuthStateChanged(async user => {
  if (!user) { alert("Please login first"); return; }

  UID = user.uid;

  let snap = await db.collection("users").doc(UID).get();
  document.getElementById("coins").innerText = snap.data().coins;
});

// APPLY PROMO
async function applyPromo() {

  let code = document.getElementById("code").value.trim();

  if (code === "") { alert("Enter code"); return; }

  let promo = await db.collection("promoCodes").doc(code).get();
  if (!promo.exists) { alert("Invalid Code"); return; }

  let p = promo.data();

  // expiry check
  let today = new Date().toISOString().slice(0,10);
  if (p.expireAt < today) {
    alert("Code Expired");
    return;
  }

  let userRef = db.collection("users").doc(UID);
  let userSnap = await userRef.get();
  let user = userSnap.data();

  if (user.usedCodes.includes(code)) {
    alert("You already used this code");
    return;
  }

  let newCoins = user.coins + p.coins;

  await userRef.update({
    coins: newCoins,
    usedCodes: firebase.firestore.FieldValue.arrayUnion(code)
  });

  document.getElementById("coins").innerText = newCoins;

  alert("Success! +" + p.coins + " coins added");
}
</script>

</body>
</html>

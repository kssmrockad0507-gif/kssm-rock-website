<!DOCTYPE html>
<html>
<head>
    <title>Redeem History</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        margin: 0;
        padding: 0;
        background: linear-gradient(180deg, #0e5d63, #07404b);
        font-family: Arial, sans-serif;
        color: white;
    }

    /* Top Bar */
    .topBar {
        width: 100%;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .backBtn {
        font-size: 30px;
        cursor: pointer;
    }

    .coinBox {
        background: white;
        color: black;
        padding: 6px 15px;
        border-radius: 20px;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .card {
        width: 90%;
        background: white;
        margin: auto;
        margin-top: 20px;
        border-radius: 25px;
        padding: 20px;
        color: black;
    }

    .historyItem {
        background: #d9e3e6;
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
        word-break: break-word;
    }

    .noData {
        text-align: center;
        padding: 20px;
        font-size: 18px;
        color: white;
    }

    .small {
        font-size: 13px;
        color: #555;
    }
</style>
</head>

<body>

<!-- ðŸ”™ TOP BAR -->
<div class="topBar">
    <div class="backBtn" onclick="goBack()">âŸµ</div>

    <div class="coinBox">
        <span id="coinValue">0</span> ðŸª™
    </div>
</div>

<!-- MAIN CARD -->
<div class="card">
    <h2 style="text-align:center;">Redeem History</h2>
    <div id="historyList"></div>
</div>

<!-- Firebase -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore, doc, getDoc,
  collection, getDocs, query, where, orderBy
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* ðŸ”¥ Firebase Config */
const firebaseConfig = {
    apiKey: "AIzaSyCBgBWfpUbtlPbvCfDr6N1_L2svtJglfhM",
    authDomain: "kssm-rock-tam-ad.firebaseapp.com",
    projectId: "kssm-rock-tam-ad",
    storageBucket: "kssm-rock-tam-ad.firebasestorage.app",
    messagingSenderId: "28268633766",
    appId: "1:28268633766:web:f6ee57eaf56f7cbd37de67"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore(app);

/* Back Button: go to index (main) */
function goBack() {
    window.location.href = "index.html";
}

/* Helper: normalise time value to JS Date */
function toDate(value){
  if (!value) return new Date();
  // Firestore Timestamp object
  if (typeof value.toDate === 'function') return value.toDate();
  // number (ms)
  if (typeof value === 'number') return new Date(value);
  // string
  const n = Number(value);
  if (!isNaN(n)) return new Date(n);
  return new Date(value);
}

/* Build a friendly label for coin/price field */
function getValueLabel(d){
  // try common fields used across your codebases
  if (d.amountCoins) return d.amountCoins + " coins";
  if (d.value) return d.value + " coins";
  if (d.amount) return d.amount + " coins";
  if (d.reward) return (d.reward !== undefined ? d.reward + " coins" : "");
  if (d.price) return d.price + " value";
  return "";
}

/* Load and render history from multiple possible places:
   - users/{uid}/history
   - users/{uid}/redeemHistory
   - global redeemCodes collection (where uid == current user)
   This makes the page robust if different code paths wrote to different names.
*/
async function loadHistoryForUser(uid){
  const listEl = document.getElementById("historyList");
  listEl.innerHTML = "";

  const collected = []; // will hold {code, label, time, source}

  // try users/{uid}/history
  try {
    const histCol1 = collection(db, "users", uid, "history");
    const snap1 = await getDocs(query(histCol1, orderBy("time", "desc")));
    snap1.forEach(s=>{
      const d = s.data();
      collected.push({
        code: d.code || d.claimedCode || "",
        label: getValueLabel(d),
        time: toDate(d.time || d.usedAt || d.claimDate || d.date),
        source: "history"
      });
    });
  } catch(e){
    console.warn("history subcollection read error:", e);
  }

  // try users/{uid}/redeemHistory
  try {
    const histCol2 = collection(db, "users", uid, "redeemHistory");
    const snap2 = await getDocs(query(histCol2, orderBy("time", "desc")));
    snap2.forEach(s=>{
      const d = s.data();
      collected.push({
        code: d.code || d.claimedCode || "",
        label: getValueLabel(d),
        time: toDate(d.time || d.usedAt || d.claimDate || d.date),
        source: "redeemHistory"
      });
    });
  } catch(e){
    console.warn("redeemHistory subcollection read error:", e);
  }

  // try global redeemed records in root "redeemCodes" where uid == user
  try {
    const globalQ = query(collection(db, "redeemCodes"), where("uid", "==", uid));
    const snap3 = await getDocs(globalQ);
    snap3.forEach(s=>{
      const d = s.data();
      collected.push({
        code: d.code || "",
        label: getValueLabel(d),
        time: toDate(d.time || d.usedAt || d.claimDate || d.date),
        source: "redeemCodes"
      });
    });
  } catch(e){
    console.warn("global redeemCodes read error:", e);
  }

  if (collected.length === 0){
    listEl.innerHTML = `<div class='noData'>No Redeem History Available</div>`;
    return;
  }

  // sort by time desc
  collected.sort((a,b) => b.time - a.time);

  // render
  for (const item of collected){
    const timeStr = item.time ? item.time.toLocaleString() : "";
    const label = item.label ? `<div class="small"><b>Value:</b> ${item.label}</div>` : "";
    listEl.innerHTML += `
      <div class="historyItem">
        <div><b>Code:</b> ${item.code || "(no code)"}</div>
        ${label}
        <div class="small"><b>Time:</b> ${timeStr}</div>
        <div class="small"><b>Source:</b> ${item.source}</div>
      </div>
    `;
  }
}

/* Load live coins and history when auth ready */
onAuthStateChanged(auth, async (user) => {
    if (!user) {
        // not logged in
        document.getElementById("coinValue").innerText = "0";
        document.getElementById("historyList").innerHTML = `<div class='noData'>Please login to see history</div>`;
        return;
    }

    // live coins display (read once; if you want realtime use onSnapshot)
    try {
      const userRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userRef);
      if (userSnap.exists()) {
          document.getElementById("coinValue").innerText = userSnap.data().coins || 0;
      } else {
          document.getElementById("coinValue").innerText = "0";
      }
    } catch(e){
      console.error("user coins read error:", e);
    }

    // load user's history from available places
    await loadHistoryForUser(user.uid);
});
</script>

</body>
</html>

<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Redeem History - KSSM ROCK</title>  <style>
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, #0e5d63, #07404b);
      font-family: Arial, sans-serif;
      color: white;
    }

    .topBar {
      width: 100%;
      padding: 14px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .backBtn {
      font-size: 28px;
      cursor: pointer;
    }

    .coinBox {
      background: white;
      color: black;
      padding: 6px 12px;
      border-radius: 18px;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .container {
      width: 92%;
      max-width: 720px;
      margin: 18px auto;
      background: white;
      color: black;
      border-radius: 20px;
      padding: 18px;
    }

    h2 { text-align:center; margin: 2px 0 12px 0; }

    .historyList { margin-top: 8px; }

    .historyItem {
      background: #d9e3e6;
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .small { font-weight:600; font-size:13px; color:#073d3a; }

    .noData {
      text-align:center;
      padding: 22px;
      font-size:18px;
      color:#fff;
      background:transparent;
    }

    @media (max-width:520px){
      .container{ width:94%; padding:16px; }
      .historyItem{ font-size:16px; }
    }
  </style></head>
<body>  <div class="topBar">
    <div class="backBtn" onclick="goHome()">←</div>
    <div class="coinBox">
      <img src="https://cdn-icons-png.flaticon.com/512/138/138292.png" width="20" alt="coin">
      <span id="liveCoins">0</span>
    </div>
  </div>  <div class="container">
    <h2>Redeem History</h2>
    <div id="historyList" class="historyList">
      <div class="noData">Loading...</div>
    </div>
  </div>  <!-- Firebase -->  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore, doc, onSnapshot, collection, query, orderBy, getDocs
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCBgBWfpUbtlPbvCfDr6N1_L2svtJglfhM",
      authDomain: "kssm-rock-tam-ad.firebaseapp.com",
      projectId: "kssm-rock-tam-ad",
      storageBucket: "kssm-rock-tam-ad.firebasestorage.app",
      messagingSenderId: "28268633766",
      appId: "1:28268633766:web:f6ee57eaf56f7cbd37de67"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Navigate back to main (index.html)
    window.goHome = function() {
      window.location.href = "index.html";
    };

    // Render history items
    function renderHistory(list) {
      const container = document.getElementById('historyList');
      container.innerHTML = '';
      if (!list || list.length === 0) {
        container.innerHTML = '<div class="noData">No Redeem History Available</div>';
        return;
      }
      list.forEach(item=>{
        // time might be Firestore timestamp or ISO string
        let timeText = '';
        if (item.time && item.time.toDate) {
          timeText = new Date(item.time.toDate()).toLocaleString();
        } else if (item.time && item.time.seconds) {
          timeText = new Date(item.time.seconds * 1000).toLocaleString();
        } else {
          timeText = item.time ? new Date(item.time).toLocaleString() : '';
        }
        container.innerHTML += `
          <div class="historyItem">
            <div><strong>Code:</strong> ${item.code ?? '—'}</div>
            <div class="small"><strong>Value:</strong> ${item.value ?? item.amount ?? '—'} </div>
            <div class="small"><strong>Time:</strong> ${timeText}</div>
          </div>
        `;
      });
    }

    // Load live coins and history for signed-in user
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("Please login to view Redeem History.");
        window.location.href = "login.html";
        return;
      }

      const userDocRef = doc(db, "users", user.uid);

      // LIVE coins update
      onSnapshot(userDocRef, (snap) => {
        if (snap.exists()) {
          // adjust field name if you use 'coins' or 'balance'
          const coins = snap.data().coins ?? snap.data().balance ?? 0;
          document.getElementById('liveCoins').innerText = coins;
        } else {
          document.getElementById('liveCoins').innerText = 0;
        }
      });

      // Load history once (ordered desc by time)
      try {
        const historyCol = collection(db, "users", user.uid, "redeemHistory");
        const q = query(historyCol, orderBy("time", "desc"));
        const snap = await getDocs(q);
        const items = [];
        snap.forEach(d => items.push(d.data()));
        renderHistory(items);
      } catch (err) {
        console.error("Load history error:", err);
        document.getElementById('historyList').innerHTML = '<div class="noData">Error loading history</div>';
      }
    });
  </script></body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>KSSM ROCK FREE REWARD</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(180deg,#0e5d63,#07404b);
}
.topbar{
  padding:14px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  color:white;
  background:rgba(255,255,255,0.12);
}
.menu-btn{font-size:30px;cursor:pointer}
.title{font-size:22px;font-weight:bold}
.coins{
  display:flex;align-items:center;
  background:rgba(255,255,255,0.25);
  padding:6px 12px;border-radius:10px;
}
.coins img{width:22px;margin-right:6px}
.box-container{padding:20px}
.big-box{
  background:white;
  color:#0e5d63;
  margin-top:18px;
  padding:22px;
  border-radius:18px;
  font-size:22px;
  font-weight:bold;
  text-align:center;
  cursor:pointer;
}
.menu-screen{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.75);
  display:none;justify-content:center;align-items:center;
}
.menu-box{
  width:80%;
  background:white;
  padding:20px;
  border-radius:15px;
  text-align:center;
}
.menu-box div{
  font-size:20px;
  padding:12px;
  border-bottom:1px solid #ccc;
  cursor:pointer;
}
.close-btn{
  margin-top:15px;
  padding:10px 18px;
  background:#0e5d63;
  color:white;border:none;border-radius:8px;
}

/* ðŸ”” Admin Announcement */
#adminMsg{
  margin:15px;
  padding:12px;
  background:#fff3cd;
  color:#333;
  border-radius:10px;
  display:none;
}

/* ðŸ’¬ Chat */
.chat-box{
  background:white;
  border-radius:15px;
  padding:15px;
}
.chat-messages{
  max-height:250px;
  overflow:auto;
  margin-bottom:10px;
}
.msg-user{color:#0e5d63;font-weight:bold}
.msg-admin{color:#d9534f;font-weight:bold}
</style>
</head>

<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="menu-btn" onclick="openMenu()">ä¸‰</div>
  <div class="title">KSSM ROCK FREE REWARD</div>
  <div class="coins">
    <img src="https://cdn-icons-png.flaticon.com/512/138/138292.png">
    <span id="coinValue">0</span>
  </div>
</div>

<!-- ðŸ”” ADMIN ANNOUNCEMENT -->
<div id="adminMsg"></div>

<!-- TASKS -->
<div class="box-container">
  <div class="big-box" onclick="location.href='Dailycoin.html'">Daily Coin</div>
  <div class="big-box" onclick="location.href='task.html'">Maths Quiz</div>
  <div class="big-box" onclick="location.href='task2.html'">Alphabet Identifier</div>
  <div class="big-box" onclick="location.href='promo.html'">Promo Code</div>
</div>

<!-- MENU -->
<div id="menuPage" class="menu-screen">
  <div class="menu-box">
    <div onclick="location.href='Redeem History.html'">Redeem History</div>
    <div onclick="location.href='Redeem Selection.html'">Redeem Selection</div>
    <div onclick="openChat()">Admin Contact</div>
    <div onclick="logoutUser()">Logout</div>
    <button class="close-btn" onclick="closeMenu()">Close</button>
  </div>
</div>

<!-- ðŸ’¬ CHAT POPUP -->
<div id="chatPage" class="menu-screen">
  <div class="chat-box">
    <h3>Admin Contact</h3>
    <div id="chatMessages" class="chat-messages"></div>
    <input id="chatInput" placeholder="Type message..." style="width:100%;padding:8px">
    <button class="close-btn" onclick="sendMsg()">Send</button>
    <button class="close-btn" onclick="closeChat()">Close</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth,onAuthStateChanged,signOut }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import {
  getFirestore,doc,getDoc,
  collection,addDoc,onSnapshot,orderBy,query,setDoc
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyCBgBWfpUbtlPbvCfDr6N1_L2svtJglfhM",
 authDomain:"kssm-rock-tam-ad.firebaseapp.com",
 projectId:"kssm-rock-tam-ad",
 storageBucket:"kssm-rock-tam-ad.firebasestorage.app",
 messagingSenderId:"28268633766",
 appId:"1:28268633766:web:f6ee57eaf56f7cbd37de67"
};

const app=initializeApp(firebaseConfig);
const auth=getAuth(app);
const db=getFirestore(app);

let currentUser=null;

onAuthStateChanged(auth,async(user)=>{
 if(!user){location.href="login.html";return;}
 currentUser=user;

 // coins
 const us=await getDoc(doc(db,"users",user.uid));
 if(us.exists()) coinValue.innerText=us.data().coins||0;

 // announcement
 const an=await getDoc(doc(db,"adminSettings","announcement"));
 if(an.exists() && an.data().text){
   adminMsg.style.display="block";
   adminMsg.innerText=an.data().text;
 }

 loadChat();
});

window.logoutUser=()=>signOut(auth).then(()=>location.href="login.html");

// CHAT
function loadChat(){
 const q=query(
  collection(db,"supportChats",currentUser.uid,"messages"),
  orderBy("time")
 );
 onSnapshot(q,snap=>{
  chatMessages.innerHTML="";
  snap.forEach(d=>{
    const m=d.data();
    chatMessages.innerHTML+=
     `<div><span class="${m.sender==='admin'?'msg-admin':'msg-user'}">
      ${m.sender}:</span> ${m.text}</div>`;
  });
 });
}

window.sendMsg=async()=>{
 const txt=chatInput.value.trim();
 if(!txt) return;
 await setDoc(doc(db,"supportChats",currentUser.uid),
 {userName:currentUser.email},{merge:true});
 await addDoc(collection(db,"supportChats",currentUser.uid,"messages"),{
  text:txt,sender:"user",time:Date.now()
 });
 chatInput.value="";
};
</script>

<script>
function openMenu(){menuPage.style.display="flex"}
function closeMenu(){menuPage.style.display="none"}
function openChat(){chatPage.style.display="flex";closeMenu()}
function closeChat(){chatPage.style.display="none"}
</script>

</body>
</html>

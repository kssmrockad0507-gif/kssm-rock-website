<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily Coins — KSSM ROCK</title>

  <style>
    /* Mobile-first layout (max-width to keep mobile look even on desktop) */
    body {
      margin:0; padding:0;
      background: linear-gradient(180deg,#0e5d63,#07404b);
      font-family: Arial, sans-serif;
      color: white;
      display: flex;
      justify-content: center;
    }
    .wrap {
      width: 92%;
      max-width: 450px; /* keeps mobile look on desktop */
      margin: 28px 0;
    }

    .mainCard {
      background: white;
      color: black;
      border-radius: 20px;
      padding: 26px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.2);
      text-align: center;
    }

    .title {
      font-size: 26px; font-weight: 800; margin-bottom: 10px;
    }
    .subtitle { color:#375b58; margin-bottom: 14px; font-weight:700; }

    .claimBtn {
      background: linear-gradient(180deg,#195c63,#0d434a);
      color: white;
      border: none;
      padding: 18px;
      border-radius: 14px;
      font-size: 22px;
      font-weight: 800;
      width: 86%;
      cursor: pointer;
      margin: 12px auto;
      display: block;
    }
    .claimBtn:disabled { opacity: 0.55; cursor: not-allowed; }

    .msg {
      margin-top:12px; font-size:18px; color: #0a7a3f; display:none;
    }

    .info {
      margin-top:10px; color:#475569; font-size:14px;
    }

    .bannerAd {
      height: 70px;
      background:#e6eef2;
      border-radius:12px;
      margin-top:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#333;
      font-weight:700;
    }

    /* fullscreen ad overlay */
    #fullAd {
      display:none;
      position:fixed; inset:0;
      background: rgba(0,0,0,0.92);
      z-index:9999; color:white;
      text-align:center; padding-top:24vh;
      font-size:20px;
    }
    #adCloseBtn {
      margin-top:26px;
      padding:14px 28px;
      border-radius:12px;
      background:#195c63;
      border:none;
      font-size:18px;
      font-weight:800;
      color:white;
      display:none;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="mainCard">
      <div class="title">Claim Today's Coins</div>
      <div class="subtitle">Get 30 Coins — Once per day</div>

      <div id="alreadyMsg" class="msg">✔ Already Claimed Today</div>

      <button id="claimButton" class="claimBtn" onclick="onClaimClick()">CLAIM 30</button>

      <div id="status" class="info">Tap CLAIM → fullscreen ad plays 10s → then CLOSE → coins added.</div>
    </div>

    <div class="bannerAd" id="bannerAd">BANNER AD AREA</div>
  </div>

  <!-- Fullscreen Ad Overlay (placeholder for real ad) -->
  <div id="fullAd">
    <div style="font-size:26px; font-weight:800; margin-bottom:10px;">FULLSCREEN AD</div>
    <div style="font-size:18px; color:#ddd; margin-bottom:6px;">Please wait <span id="adSec">10</span> seconds...</div>
    <div id="adCloseBtn" onclick="onAdClose()">CLOSE AD</div>
  </div>

  <!-- Firebase + Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, runTransaction
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    // ---------- config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCBgBWfpUbtlPbvCfDr6N1_L2svtJglfhM",
      authDomain: "kssm-rock-tam-ad.firebaseapp.com",
      projectId: "kssm-rock-tam-ad",
      storageBucket: "kssm-rock-tam-ad.firebasestorage.app",
      messagingSenderId: "28268633766",
      appId: "1:28268633766:web:f6ee57eaf56f7cbd37de67"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- UI refs ----------
    const claimBtn = document.getElementById('claimButton');
    const alreadyMsg = document.getElementById('alreadyMsg');
    const statusEl = document.getElementById('status');
    const fullAd = document.getElementById('fullAd');
    const adSecEl = document.getElementById('adSec');
    const adCloseBtn = document.getElementById('adCloseBtn');

    // session vars
    let uid = null;
    let inProgress = false; // prevents double UI clicks

    // ensure user logged in
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        // redirect to login page if not logged in
        window.location.href = 'login.html';
        return;
      }
      uid = user.uid;
      await refreshClaimStatus(); // check server if already claimed today
    });

    // helper: today's date string YYYY-MM-DD
    function todayISO() {
      return new Date().toISOString().split('T')[0];
    }

    // check server lastClaim and set UI
    async function refreshClaimStatus() {
      if (!uid) return;
      try {
        const userRef = doc(db, 'users', uid);
        const snap = await getDoc(userRef);
        if (!snap.exists()) {
          // create minimal doc if missing
          // (This is optional — you may prefer creating at login)
          // We'll not auto-write here to respect user preference
          return;
        }
        const data = snap.data();
        if (data && data.lastClaim === todayISO()) {
          claimBtn.disabled = true;
          claimBtn.style.display = 'none';
          alreadyMsg.style.display = 'block';
          statusEl.textContent = 'You already claimed today. Come back after 00:00 (server time).';
        } else {
          claimBtn.disabled = false;
          claimBtn.style.display = 'block';
          alreadyMsg.style.display = 'none';
          statusEl.textContent = 'Tap CLAIM → fullscreen ad plays 10s → then CLOSE → coins added.';
        }
      } catch (err) {
        console.error('refreshClaimStatus err', err);
      }
    }

    // Called when user taps CLAIM
    export function onClaimClick() {
      if (inProgress) return;
      inProgress = true;
      claimBtn.disabled = true;

      // double-check server before showing ad (prevents stale UI)
      runPreClaimCheckThenShowAd();
    }

    async function runPreClaimCheckThenShowAd() {
      try {
        const userRef = doc(db, 'users', uid);
        const snap = await getDoc(userRef);
        const last = snap.exists() ? snap.data().lastClaim : null;
        if (last === todayISO()) {
          // already claimed on server — immediate feedback
          claimBtn.style.display = 'none';
          alreadyMsg.style.display = 'block';
          statusEl.textContent = 'Already claimed today (server).';
          inProgress = false;
          return;
        }
        // else show the fullscreen ad placeholder
        showFullscreenAd();
      } catch (err) {
        console.error('pre-check error', err);
        // allow retry
        claimBtn.disabled = false;
        inProgress = false;
      }
    }

    // show fullscreen ad countdown
    function showFullscreenAd() {
      fullAd.style.display = 'block';
      adCloseBtn.style.display = 'none';
      let sec = 10;
      adSecEl.textContent = sec;
      const timer = setInterval(() => {
        sec--;
        adSecEl.textContent = sec;
        if (sec <= 0) {
          clearInterval(timer);
          // enable close button
          adCloseBtn.style.display = 'inline-block';
        }
      }, 1000);
    }

    // Called when user presses CLOSE AD (after 10s)
    window.onAdClose = async function onAdClose() {
      // Immediately hide overlay for UX
      fullAd.style.display = 'none';
      adCloseBtn.style.display = 'none';
      statusEl.textContent = 'Finishing claim...';

      // Perform atomic server transaction:
      // if lastClaim !== today => coins += 30, lastClaim = today
      // else throw and inform user
      try {
        const userRef = doc(db, 'users', uid);

        await runTransaction(db, async (tx) => {
          const snap = await tx.get(userRef);
          let data = snap.exists() ? snap.data() : null;

          // if document missing, create initial values
          if (!data) {
            // create doc with coins=0 and lastClaim null (will update below)
            tx.set(userRef, { coins: 0, lastClaim: '' }, { merge: true });
            data = { coins: 0, lastClaim: '' };
          }

          if (data.lastClaim === todayISO()) {
            // already claimed — abort
            throw new Error('ALREADY_CLAIMED');
          }

          // otherwise safe to add coins
          const newCoins = (typeof data.coins === 'number' ? data.coins : 0) + 30;
          tx.update(userRef, { coins: newCoins, lastClaim: todayISO() });
        });

        // Transaction succeeded
        claimBtn.style.display = 'none';
        alreadyMsg.style.display = 'block';
        alreadyMsg.textContent = '✔ You received 30 coins!';
        statusEl.textContent = 'Success — 30 coins added to your account.';
      } catch (err) {
        console.error('transaction err', err);
        if (err && err.message === 'ALREADY_CLAIMED') {
          // someone else/another tab already claimed — reflect server state
          claimBtn.style.display = 'none';
          alreadyMsg.style.display = 'block';
          alreadyMsg.textContent = '✔ Already Claimed Today';
          statusEl.textContent = 'Already claimed (server).';
        } else {
          // some other error
          statusEl.textContent = 'Error while adding coins. Try again.';
          claimBtn.disabled = false;
        }
      } finally {
        inProgress = false;
      }
    };

    // Expose onClaimClick for inline onclick (since using module)
    window.onClaimClick = onClaimClick;
  </script>
</body>
</html>

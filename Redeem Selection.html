<!DOCTYPE html>
<html>
<head>
    <title>Redeem Selection</title>

    <!-- CSS Theme -->
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(180deg, #0e5d63, #07404b);
            font-family: Arial, sans-serif;
            color: white;
        }

        .topBar {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
        }

        .backBtn {
            font-size: 30px;
            cursor: pointer;
        }

        .coinBox {
            background: white;
            color: black;
            display: flex;
            align-items: center;
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 22px;
        }

        .card {
            width: 85%;
            margin: auto;
            background: white;
            border-radius: 25px;
            padding: 20px;
            color: black;
            text-align: center;
            margin-top: 20px;
        }

        .redeemBtn {
            width: 80%;
            margin: auto;
            background: linear-gradient(180deg, #195c63, #0d434a);
            padding: 18px;
            text-align: center;
            border-radius: 15px;
            margin-top: 20px;
            font-size: 25px;
            font-weight: bold;
            cursor: pointer;
            color: white;
        }

        #overlayScreen {
            display: none;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.75);
            position: fixed;
            top: 0;
            left: 0;
            color: white;
            text-align: center;
            padding-top: 200px;
            font-size: 28px;
        }
    </style>

</head>

<body>

    <div class="topBar">
        <div class="backBtn" onclick="history.back()">←</div>

        <div class="coinBox">
            <span id="coinValue">0</span> Coins
        </div>
    </div>

    <div class="card">
        <h2>Redeem Options</h2>

        <div class="redeemBtn" onclick="openRedeemList('10rs',1000)">
            ₹10 Redeem = 1000 Coins
        </div>

        <div class="redeemBtn" onclick="openRedeemList('20rs',2000)">
            ₹20 Redeem = 2000 Coins
        </div>

        <div class="redeemBtn" onclick="openRedeemList('50rs',5000)">
            ₹50 Redeem = 5000 Coins
        </div>
    </div>

    <div id="overlayScreen"></div>

    <!-- Firebase -->
    <script type="module">

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCBgBWfpUbtlPbvCfDr6N1_L2svtJglfhM",
            authDomain: "kssm-rock-tam-ad.firebaseapp.com",
            projectId: "kssm-rock-tam-ad",
            storageBucket: "kssm-rock-tam-ad.firebasestorage.app",
            messagingSenderId: "28268633766",
            appId: "1:28268633766:web:f6ee57eaf56f7cbd37de67"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.2/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, getDocs, updateDoc, addDoc } 
        from "https://www.gstatic.com/firebasejs/10.7.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } 
        from "https://www.gstatic.com/firebasejs/10.7.2/firebase-auth.js";

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth();

        let currentUID = null;

        //-----------------------------
        // LIVE COIN SHOW
        //-----------------------------
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUID = user.uid;
                const userRef = doc(db, "users", currentUID);
                const snap = await getDoc(userRef);
                if (snap.exists()) {
                    document.getElementById("coinValue").innerText = snap.data().coins;
                }
            }
        });

        //-----------------------------
        // REDEEM OPTION CLICKED
        //-----------------------------
        async function openRedeemList(category, cost) {

            const userRef = doc(db, "users", currentUID);
            const userData = await getDoc(userRef);

            if (userData.data().coins < cost) {
                alert("Not enough coins!");
                return;
            }

            // Check database for available code
            const codeRef = collection(db, "redeemCategories", category, "codes");
            const codeSnap = await getDocs(codeRef);

            let foundCode = null;
            codeSnap.forEach(docu => {
                if (docu.data().isUsed === false && foundCode === null) {
                    foundCode = { id: docu.id, data: docu.data() };
                }
            });

            if (foundCode === null) {
                alert("No Code Available!");
                return;
            }

            // Show ad simulation
            let overlay = document.getElementById("overlayScreen");
            overlay.style.display = "block";
            overlay.innerHTML = "Loading Ad... 10 sec";

            let sec = 10;
            let x = setInterval(() => {
                sec--;
                overlay.innerHTML = "Loading Ad... " + sec + " sec";
                if (sec <= 0) {
                    clearInterval(x);
                    overlay.style.display = "none";
                    confirmRedeem(foundCode, cost, category);
                }
            }, 1000);
        }

        //-----------------------------
        // CONFIRM REDEEM AND SAVE TO HISTORY
        //-----------------------------
        async function confirmRedeem(codeObj, cost, category) {

            // Subtract coins
            const userRef = doc(db, "users", currentUID);
            const userSnap = await getDoc(userRef);
            let newCoins = userSnap.data().coins - cost;

            await updateDoc(userRef, { coins: newCoins });
            document.getElementById("coinValue").innerText = newCoins;

            // Mark code used
            const usedRef = doc(db, "redeemCategories", category, "codes", codeObj.id);
            await updateDoc(usedRef, { isUsed: true });

            // Save in redeemCodes (user history)
            await addDoc(collection(db, "redeemCodes"), {
                uid: currentUID,
                code: codeObj.data.code,
                category: category,
                time: Date.now()
            });

            // Redirect to history page
            window.location.href = "redeem-history.html";
        }

        window.openRedeemList = openRedeemList;
    </script>

</body>
</html>
